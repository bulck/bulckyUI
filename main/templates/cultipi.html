<script>
   $("[title]").tooltip({ 
        position: { my: "left+15 center", at: "right center" },
        close: function (event, ui) {
            ui.tooltip.hover(
            function () {
                $(this).stop(true).fadeTo(300, 1);
            },    
            function () {
                $(this).fadeOut("300", function () {
                    $(this).remove();
                })
            });
        } 
    });
</script>

<?php 
    cultipi\check_db();
?>

<!-- Section synoptic -->
<div id="div_synoptic_ui" style="">
    <!-- Display buttons -->
    <table class="table_width">
        <tr>
            <td class="calendar-conf-marge"></td> 
            <td class="calendar-title">
                <!-- Button to add a element -->
                <input type="image" id="syno_add_element" name="syno_add_element"
                       title="<?php echo __('CULTIPI_SYNO_ADD_ELEMENT'); ?>"
                       src="main/libs/img/db_add.png"  
                       alt="calendar"  
                />        
                <input type="image" id="syno_webcam" name="syno_webcam"
                       title="<?php echo __('TOOLTIP_WEBCAM'); ?>"
                       src="main/libs/img/webcam_icon.png"  
                       alt="webcam"  
                />
            </td>
            <td class="calendar-conf-marge"></td>
            <td ><p class="pInline" ><?php echo __('SYNO_UPDATE_SENSOR_HOUR'); ?></p><p class="pInline" id="synoptic_updateSensorHour" ></p></td>
            <td ><p class="pInline" ><?php echo __('SYNO_UPDATE_PLUG_HOUR'); ?></p><p class="pInline" id="synoptic_updatePlugHour" ></p></td>
            <td ><p class="pInline" >
                <input type="image" id="synoptic_updateCultipiStatus"
                       title="<?php echo __('SYNO_UPDATE_CULTIPI_STATUS_START'); ?>"
                       src="main/libs/img/one_pixel.png"  
                       alt="starting"
                       width="14"
                />
                </p>
            </td>
        </tr>
    </table>
    <br />
    <hr class="hr_cultipi" />
    <br />

    <div id="set" style="min-height: 700px;" >

        <?php
            // Add every sensor

            // Read sensor list
            $sensorList = cultipi\getSensorOfSynoptic();

            // retrieve values
            $sensorValues = cultipi\getAllSensorLiveValue();

            foreach ($sensorList as $index => $sensor) 
            {
                echo '<div id="syno_elem_' . $sensor["id"] . '" class="" style="position:absolute; top:' . $sensor["y"] . 'px ; left:' . $sensor["x"] . 'px ;z-index:' . $sensor["z"] . '" >';
                echo '  <table>';
                echo '    <tr>';
                echo '      <td id="syno_elem_title_' . $sensor["id"] . '" >Capteur ' . $sensor["indexElem"] . '</td>';
                echo '      <td>';
                echo '          <input type="image" id="syno_elemConfigur_' . $sensor["id"] . '" name="syno_elemConfigur_' . $sensor["id"] . '"';
                echo '                 title=""';
                echo '                 src="main/libs/img/advancedsettings.png"  width="22"';
                echo '                 alt="configure"';
                echo '                 class="syno_conf_elem_button"';
                echo '          />';
                echo '      </td>';
                echo '    </tr>';
                echo '    <tr>';
                $sensorValuesList = explode(" ", $sensorValues[$sensor["indexElem"]]);
                if (!array_key_exists(1, $sensorValuesList)) {$sensorValuesList[1] = "";}

                $newStyle = "";
                $tootlTipText = "";
                $newText = "";
                switch ($sensor["image"])
                {
                    case 'T_RH_sensor.png' :
                        $newText = $tootlTipText = $sensorValuesList[0] . "°C " . $sensorValuesList[1] . "RH" ;
                        break;
                    case 'water_T_sensor.png': 
                        $newText = $tootlTipText = $sensorValuesList[0] . "°C";
                        break;
                    case 'level_sensor.png': 
                        $newText = $tootlTipText = $sensorValuesList[0] . "cm";
                        break;
                    case 'pH-sensor.png': 
                        $newText = $tootlTipText = $sensorValuesList[0] . "ph";
                        break;
                    case 'conductivity-sensor.png': 
                        $newText = $tootlTipText = $sensorValuesList[0] . "ec";
                        break;
                    case 'dissolved-oxygen-sensor.png': 
                        $newText = $tootlTipText = $sensorValuesList[0] . "OD";
                        break;
                    case 'ORP-sensor.png': 
                        $newText = $tootlTipText = $sensorValuesList[0] . "ORP";
                        break;
                    default :
                        $newText = $tootlTipText = $sensorValuesList[0] . "???";
                        break;
                }

                // If defcom, set opacity to 0.4
                if ($sensorValuesList[0] == "DEFCOM" || $sensorValuesList[0] == "TIMEOUT") {
                    $newStyle = 'opacity: 0.4;';
                    $tootlTipText = __($sensorValuesList[0]);
                    $newText = "";
                }

                echo '      <td colspan="2" ><p id="syno_elemValueSensor_val1_' . $sensor["indexElem"] . '" class="pInline" >' . $newText . '</p>';
                echo '      </td>';
                echo '    </tr>';
                echo '    <tr>';
                $newHeight = "";
                if ($sensor["rotation"] == 90 || $sensor["rotation"] == 270)
                {
                    $newHeight = 'style="height:' . $sensor["scale"] . 'px;"';
                }
                echo '      <td id="syno_elemImage_' . $sensor["id"] . '_td" colspan="3" ' . $newHeight . ' >';
                echo '          <img id="syno_elemImage_' . $sensor["id"] . '" name="syno_elemSensorImage_' . $sensor["indexElem"] . '" ';
                echo '              src="main/libs/img/images-synoptic-sensor/' . $sensor["image"] . '" ';
                echo '              style="width:' . $sensor["scale"] . 'px;cursor: move; ' . $newStyle . ';" ';
                echo '              title="' . $tootlTipText .'" ';
                echo '              alt="capteur" ';
                echo '              class="rotate' . $sensor["rotation"] . '">';
                echo '      </td>';
                echo '    </tr>';
                echo '  </table>';
                echo '</div>';
            }

            // Add plugs

            // Read plug list
            $plugList = cultipi\getPlugOfSynoptic();
            
            // retrieve values
            $plugValues = cultipi\getAllPlugLiveValue();
            
            foreach ($plugList as $index => $plug) 
            {
                echo '<div id="syno_elem_' . $plug["id"] . '" style="position:absolute; top:' . $plug["y"] . 'px ; left:' . $plug["x"] . 'px ;z-index:' . $plug["z"] . '" >';
                echo '  <table>';
                echo '    <tr>';
                echo '      <td id="syno_elem_title_' . $plug["id"] . '" >' . $plug["PLUG_NAME"] . '</td>';
                echo '      <td>';
                echo '          <input type="image" id="syno_elemConfigur_' . $plug["id"] . '" name="syno_elemConfigur_' . $plug["id"] . '"';
                echo '                 src="main/libs/img/advancedsettings.png"  width="22"';
                echo '                 alt="configure"';
                echo '                 class="syno_conf_elem_button"';
                echo '          />';
                echo '      </td>';
                echo '      <td>';
                echo '          <input type="image" id="syno_pilotPlug_' . $plug["id"] . '" name="syno_pilotPlug_' . $plug["id"] . '"';
                echo '                 src="main/libs/img/rpi_restart.png"  width="22"';
                echo '                 alt="pilot"';
                echo '                 class="syno_pilot_plug_elem_button"';
                echo '          />';
                echo '      </td>';
                echo '    </tr>';
                echo '    <tr>';
                $newHeight = "";
                if ($plug["rotation"] == 90 || $plug["rotation"] == 270)
                {
                    $newHeight = 'style="height:' . $plug["scale"] . 'px;"';
                }
                echo '      <td id="syno_elemImage_' . $plug["id"] . '_td" colspan="3" ' . $newHeight . ' >';
                // If defcom, set opacity to 0.4
                $newStyle = "";
                $tootlTipText = $plugValues[$plug["indexElem"]];
                if ($plugValues[$plug["indexElem"]] == "DEFCOM" || $plugValues[$plug["indexElem"]] == "TIMEOUT") {
                    $newStyle = 'opacity: 0.4;';
                    $tootlTipText = __($plugValues[$plug["indexElem"]]);
                } elseif ($tootlTipText == "on") {
                    $tootlTipText = __("VALUE_ON");
                }elseif ($tootlTipText == "off") {
                    $tootlTipText = __("VALUE_OFF");
                }
                echo '          <img id="syno_elemImage_' . $plug["id"] . '" name="syno_elemPlugImage_' . $plug["indexElem"] . '" ';
                echo '              src="main/libs/img/images-synoptic-plug/' . $plug["image"] . '" alt="Prise" ';
                echo '              style="' . $newStyle . 'width:' . $plug["scale"] . 'px;cursor: move";" ';
                echo '              title="' . $tootlTipText .'" ';
                echo '              class="rotate' . $plug["rotation"] . '">';
                echo '      </td>';
                echo '    </tr>';
                echo '  </table>';
                echo '</div>';
            }
            
            // Add other items
            $otherList = cultipi\getOtherOfSynoptic();
            foreach ($otherList as $index => $other) 
            {
                echo '<div id="syno_elem_' . $other["id"] . '" class="" style="position:absolute; top:' . $other["y"] . 'px ; left:' . $other["x"] . 'px ;z-index:' . $other["z"] . '" >';
                echo '  <table>';
                echo '    <tr>';
                echo '      <td id="syno_elem_title_' . $other["id"] . '" ></td>';
                echo '      <td>';
                echo '          <input type="image" id="syno_elemConfigur_' . $other["id"] . '" name="syno_elemConfigur_' . $other["id"] . '"';
                echo '                 title=""';
                echo '                 src="main/libs/img/advancedsettings.png"  width="22"';
                echo '                 alt="configure"';
                echo '                 class="syno_conf_elem_button"';
                echo '          />';
                echo '      </td>';
                echo '    </tr>';
                $newHeight = "";
                if ($other["rotation"] == 90 || $other["rotation"] == 270)
                {
                    $newHeight = 'style="height:' . $other["scale"] . 'px;"';
                }
                echo '      <td id="syno_elemImage_' . $other["id"] . '_td" colspan="3" ' . $newHeight . ' >';
                echo '      <img id="syno_elemImage_' . $other["id"] . '" src="main/libs/img/images-synoptic-other/' . $other["image"] . '" ';
                echo '          alt="Prise"';
                echo '          style="width:' . $other["scale"] . 'px;cursor: move"';
                echo '          class="rotate' . $other["rotation"] . ';" ';
                echo '      ">';
                echo '    </td></tr>';
                echo '  </table>';
                echo '</div>';
            }
            
            
        ?>
    </div>
    
    <!-- Drag message box for add element-->
    <div id="syno_add_element_ui" style="display:none" title="<?php echo __('CULTIPI_SYNO_ADD_ELEMENT'); ?>">
        <?php 
            $dir    = '../../libs/img/images-synoptic-other';
            $files  = array_diff(scandir($dir), array('..', '.'));
            foreach ($files as $file)
            {
                if (pathinfo($file, PATHINFO_EXTENSION) == "png")
                {
                    echo '<div class="syno_add_element_elem" id="' . $file . '">';
                    echo '    <img src="main/libs/img/images-synoptic-other/' . $file . '" alt="' . basename($file) . '" style="width:40px; cursor: move" >';
                    echo '</div>';
                }
            }
        ?>
    </div>

    <!-- Message box for configuring element-->
    <div id="syno_configure_element" style="display:none" title="<?php echo __('CULTIPI_SYNO_CONF'); ?>">
        <table>
            <tr>
                <td>Image</td>
                <td colspan="3" >
                    <?php 
                        echo '<select id="syno_configure_element_image_other" style="display:none" >';
                        $dir    = '../../libs/img/images-synoptic-other';
                        $files  = array_diff(scandir($dir), array('..', '.'));
                        foreach ($files as $file)
                        {
                            if (pathinfo($file, PATHINFO_EXTENSION) == "png")
                            {
                                echo '<option value="' . $file . '" >' . basename($file) . '</option>';
                            }
                        }
                        echo '</select>';

                        echo '<select id="syno_configure_element_image_plug" style="display:none" >';
                        $dir    = '../../libs/img/images-synoptic-plug';
                        $files  = array_diff(scandir($dir), array('..', '.'));
                        foreach ($files as $file)
                        {
                            if ((pathinfo($file, PATHINFO_EXTENSION) == "png" || pathinfo($file, PATHINFO_EXTENSION) == "gif") 
                                && strpos(basename($file), "_OFF"))
                            {
                                // Create file name (remove extension and _ON)
                                $newFileName = str_replace("_OFF.gif", "", str_replace("_OFF.png", "", basename($file)));
                                echo '<option value="' . $file . '" >' . $newFileName . '</option>';
                            }
                        }
                        echo '</select>';

                        echo '<select id="syno_configure_element_image_sensor" style="display:none" >';
                        $dir    = '../../libs/img/images-synoptic-sensor';
                        $files  = array_diff(scandir($dir), array('..', '.'));
                        foreach ($files as $file)
                        {
                            if (pathinfo($file, PATHINFO_EXTENSION) == "png")
                            {
                                echo '<option value="' . $file . '" >' . basename($file) . '</option>';
                            }
                        }
                        echo '</select>';
                    ?>
                    
                </td>
            </tr>
            <tr>
                <td><?php echo __('CULTIPI_SYNO_ROTATION'); ?></td>
                <td><input id="syno_configure_element_rotate_0" type="radio" name="syno_configure_element_rotate" value="0" /> 0° </td>
                <td><input id="syno_configure_element_rotate_90" type="radio" name="syno_configure_element_rotate" value="90" /> 90° </td>
                <td><input id="syno_configure_element_rotate_180" type="radio" name="syno_configure_element_rotate" value="180" /> 180° </td>
                <td><input id="syno_configure_element_rotate_270" type="radio" name="syno_configure_element_rotate" value="270" /> 270° </td>
            </tr>
            <tr>
                <td><?php echo __('CULTIPI_SYNO_PROFONDEUR'); ?></td>
                <td class="conf-field-cultipi"><input type="text" name="syno_configure_element_zindex_val" id="syno_configure_element_zindex_val" value="" size="4" readonly /></td>
                <td colspan="3" ><div id="syno_configure_element_zindex"></div></td>
            </tr>
            <tr>
                <td><?php echo __('CULTIPI_SYNO_ZOOM'); ?></td>
                <td><input type="text" name="syno_configure_element_scale_val" id="syno_configure_element_scale_val" value="" size="4" readonly /></td>
                <td colspan="3" ><div id="syno_configure_element_scale"></div></td>
            </tr>          
        </table>
    </div>
    
    <!-- Message box for pilot a plug -->
    <div id="syno_pilotPlug_element" style="display:none" title="<?php echo __('CULTIPI_SYNO_PILOTAGE'); ?>">
        <table class="table_width" >
            <tr id="syno_configure_element_force_plug_on_off">
                <td>Valeur : </td>
                <td>
                    <select id="syno_configure_element_force_plug_value" >
                        <option value="on">On</option>
                        <option value="off">Off</option>
                    </select>
                </td>
            </tr>
            <tr id="syno_configure_element_force_plug_xmax_1">
                <td>Multi : </td>
                <td><input type="text" name="syno_configure_element_force_plug_xmax_1_slider_val" id="syno_configure_element_force_plug_xmax_1_slider_val" value="" size="2" /></td>
                <td colspan="2"><div id="syno_configure_element_force_plug_xmax_1_slider"></div></td>
            </tr>
            <tr id="syno_configure_element_force_plug_xmax_2">
                <td>Bleu : </td>
                <td><input type="text" name="syno_configure_element_force_plug_xmax_2_slider_val" id="syno_configure_element_force_plug_xmax_2_slider_val" value="" size="2" /></td>
                <td colspan="2"><div id="syno_configure_element_force_plug_xmax_2_slider"></div></td>
            </tr>
            <tr id="syno_configure_element_force_plug_xmax_3">
                <td>Rouge : </td>
                <td><input type="text" name="syno_configure_element_force_plug_xmax_3_slider_val" id="syno_configure_element_force_plug_xmax_3_slider_val" value="" size="2" /></td>
                <td colspan="2"><div id="syno_configure_element_force_plug_xmax_3_slider"></div></td>
            </tr>
            <tr id="syno_configure_element_force_plug_dimmer">
                <td>Valeur : </td>
                <td><input type="text" name="syno_configure_element_force_plug_dimmer_slider_val" id="syno_configure_element_force_plug_dimmer_slider_val" value="" size="2" /></td>
                <td colspan="2"><div id="syno_configure_element_force_plug_dimmer_slider"></div></td>
            </tr>
            <tr id="syno_configure_element_force_plug">
                <td><?php echo __('CULTIPI_SYNO_PILOTAGE'); ?></td>
                <td colspan="2" >
                    <select id="syno_configure_element_force_plug_time" >
                        <option value="5">5s</option>
                        <option value="30">30s</option>
                        <option value="60">1min</option>
                        <option value="600">10min</option>
                        <option value="3600">1h</option>
                    </select>
                </td>
                <td>
                    <input type="button" id="syno_configure_element_force_plug_pilot" name="syno_configure_element_force_plug_pilot" value="<?php echo __('CULTIPI_SYNO_PILOTER'); ?>" />
                </td>
            </tr>
        </table>
    </div>
    
</div>

<div id="show_webcam" style="display:none" title="<?php echo __('MENU_WEBCAM'); ?>"> 
    <p class="p_center">
    <?php for($i=0;$i<$GLOBALS['MAX_WEBCAM'];$i++) { ?>
            <input type="radio" name="webcam" id="webcam_id<?php echo $i; ?>" value="<?php echo $i; ?>" <?php if($i==0) echo ' checked'; ?>/>
    <?php } ?>
    </p>
    <br />
    <hr />
    <br />
    <?php for($i=0;$i<$GLOBALS['MAX_WEBCAM'];$i++) { ?>
        <div id="webcam<?php echo $i; ?>" style="display:none" class="step">
            <img id="screen_webcam<?php echo $i; ?>" src="<?php echo $screen{$i}; ?>" title="" class="screenshot" alt="" style="display:none" />
            <div id="div_link_webcam<?php echo $i; ?>" style="display:none"><a href="" id="link_webcam<?php echo $i; ?>" name="<?php echo $i; ?>"><img src='/cultibox/main/libs/img/update_rpi.png' alt='' title="" /></a></div>

            <div id="error_webcam<?php echo $i; ?>" style="display:none" class="error_field">
                <p class="p_center">
                   <?php echo $webcam_conf[$i]['name']." ".__('ERROR_WEBCAM'); ?> 
                </p>
            </div>

            <div id="configure_webcam<?php echo $i; ?>" style="display:none">
                <table class="table_width">
                    <tr>
                        <td  class="conf-marge-cultipi"></td>
                        <td class="conf-title-webcam"><?php echo __('TITLE_WEBCAM'); ?>: </td>
                        <td class="conf-marge-cultipi"><input type="text" size=30 maxlength="30" id="webcam_name<?php echo $i; ?>" name="webcam_name<?php echo $i; ?>" value="<?php echo $webcam_conf[$i]['name']; ?>" /></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td  class="conf-marge-cultipi"></td>
                        <td class="conf-title-webcam"><?php echo __('BRIGHTNESS'); ?>: </td>
                        <td class="conf-marge-cultipi"><div class="slider_div" id="brightness_slider<?php echo $i; ?>"></div></td>
                        <td><input type="text" name="brightness" id="brightness<?php echo $i; ?>" value="<?php echo $webcam_conf[$i]['brightness']; ?>" size="4" readonly />%</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><?php echo __('CONTRAST'); ?>:</td>
                        <td><div id="contrast_slider<?php echo $i; ?>" class="slider_div"></div></td>
                        <td><input type="text" name="contrast" id="contrast<?php echo $i; ?>" value="<?php echo $webcam_conf[$i]['contrast']; ?>" size="4" readonly />%</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><?php echo __('RESOLUTION'); ?>:</td>
                        <td>
                            <select name="resolution_value" id="resolution_value<?php echo $i; ?>">
                                <?php foreach( $GLOBALS['WEBCAM_RESOLUTION'] as $key) { ?>
                                    <option value="<?php echo $key; ?>" <?php if(strcmp($webcam_conf[$i]['resolution'],"$key")==0) echo 'selected'; ?>><?php echo $key; ?></option>
                                <?php } ?>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><?php echo __('PALETTE'); ?>:</td>
                        <td>
                            <select name="palette_value" id="palette_value<?php echo $i; ?>">
                                <?php foreach( $GLOBALS['WEBCAM_PALETTE'] as $key) { ?>
                                    <option value="<?php echo $key; ?>" <?php if(strcmp($webcam_conf[$i]['palette'],"$key")==0) echo 'selected'; ?>><?php echo $key; ?></option>
                                <?php } ?>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                </table>
            </div>
        </div>

    <?php } ?>
</div>
